USE $(usedbname)
GO

PRINT '=============================================================='
PRINT 'Drop STForceCollection ==================================='
GO

drop function if exists [$(owner)].[STForceCollection];
go

PRINT '=============================================================='
PRINT 'Creating STForceCollection ==================================='
GO

create function [$(owner)].[STForceCollection] (
  @p_polygon         geometry,
  @p_linestrings     int = 0, /* 0 means polygons will be GC elements, otherwise LINESTRINGS */
  @p_multilinestring int = 0
)
Returns geometry
As
/****m* GEOPROCESSING/STForceCollection (2008)
 *  NAME
 *    STForceCollection -- Creates a square buffer to left or right of a linestring.
 *  SYNOPSIS
 *    Function [$(owner)].[STForceCollection] (
 *       @p_polygon         geometry,
 *       @p_linestrings     int = 0, /* 0 means polygons will be GC elements, otherwise LINESTRINGS */
 *       @p_multilinestring int = 0
 *    )
 *    Returns geometry
 *  DESCRIPTION
 *    This function extracts the rings of a polygon and returns them within 
 *    a GeometryCollection or a MultLineString.
 *    Polygons rings as polygons can only be returned in a GeometryCollection.
 *    Polygon rings can be converted to LineStrings and returned in a GeometryCollection with no checking of validity by SQL Server Spatial.
 *    Polygon rings can be converted to LineStrings and returned in a MultiLineStrings but are subject to validition by SQL Server Spatial.
 *    If @p_linestrings = 0 and @p_multilinestring is 1 the function changes to @p_multilinestring 0 as polygons cannot be returned in a MultiLineString.
 *  NOTES
 *    1. Supports CompoundCurves in polygon rings
 *    2. See PostGIS's ST_ForceCollection 
 *  INPUTS
 *    @p_polygon    (geometry) - Must be a Polygon geometry.
 *    @p_linestrings     (int) - Rings are to be converted to LineStrings if 1, otherwise Polygons.
 *    @p_multilinestring (int) - Return rings using GeometryCollection (0) or MultiLineString (1)
 *  RESULT
 *    collection    (geometry) - Eithre MultiLineString or GeometryCollection.
 *  EXAMPLE
 *    select [$(owner)].[STForceCollection](
 *                 geometry::STGeomFromText('POLYGON ((98.4 883.585, 115.729 903.305, 102.284 923.025, 99.148 899.272, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 96.606 926.91, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 119.017 922.28, 119.724 924.15, 101.945 930.873, 101.842 930.909, 101.737 930.939, 101.63 930.963, 101.522 930.982, 101.413 930.994, 101.304 931.001, 101.194 931.002, 101.085 930.996, 95.259 930.548, 95.158 930.538, 95.057 930.522, 94.958 930.502, 94.859 930.476, 94.762 930.446, 94.667 930.41, 94.574 930.37, 94.483 930.325, 94.394 930.275, 94.308 930.221, 94.224 930.163, 94.144 930.101, 94.067 930.034, 93.994 929.964, 93.924 929.89, 93.858 929.813, 93.796 929.732, 93.738 929.649, 93.685 929.562, 93.636 929.473, 93.591 929.382, 93.552 929.288, 93.517 929.193, 93.487 929.096, 93.462 928.997, 93.442 928.898, 93.427 928.797, 93.417 928.696, 93.412 928.595, 93.413 928.493, 93.419 928.391, 93.429 928.29, 93.727 926.049, 93.755 925.89, 93.796 925.733, 93.849 925.579, 93.915 925.431, 93.992 925.288, 94.081 925.152, 94.181 925.024, 94.29 924.905, 94.292 924.902, 91.428 905.295, 91.411 905.297, 91.269 905.305, 91.127 905.302, 79.324 904.704, 79.222 904.697, 79.121 904.684, 79.021 904.666, 78.922 904.643, 78.824 904.615, 78.728 904.582, 78.634 904.544, 78.541 904.501, 78.451 904.454, 78.364 904.402, 78.279 904.346, 78.197 904.286, 78.118 904.221, 78.043 904.153, 77.971 904.081, 77.903 904.005, 77.839 903.926, 77.779 903.844, 77.724 903.758, 77.672 903.671, 77.626 903.58, 77.584 903.488, 77.546 903.393, 77.514 903.297, 77.486 903.199, 77.464 903.099, 77.446 902.999, 77.434 902.898, 77.427 902.797, 77.425 902.695, 77.428 902.593, 77.437 902.492, 77.683 900.217, 74.343 901.496, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 63.291 914.361, 73.036 899.855, 80.022 897.18, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 79.736 888.304, 98.4 883.585), (97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823), (88.909 888.047, 83.17 889.498, 90.523 899.096, 88.909 888.047), (101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06))',0),
 *              0,
 *              0
 *           ).AsTextZM() as gCollection;
 *    GO
 *    
 *    gCollection
 *    GEOMETRYCOLLECTION (POLYGON ((97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823)), POLYGON ((88.909 888.047, 83.17 889.498, 90.523 899.096, 88.909 888.047)), POLYGON ((101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06)), POLYGON ((101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06)))
 *    
 *    select [$(owner)].[STForceCollection](
 *                 geometry::STGeomFromText('POLYGON ((98.4 883.585, 115.729 903.305, 102.284 923.025, 99.148 899.272, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 96.606 926.91, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 119.017 922.28, 119.724 924.15, 101.945 930.873, 101.842 930.909, 101.737 930.939, 101.63 930.963, 101.522 930.982, 101.413 930.994, 101.304 931.001, 101.194 931.002, 101.085 930.996, 95.259 930.548, 95.158 930.538, 95.057 930.522, 94.958 930.502, 94.859 930.476, 94.762 930.446, 94.667 930.41, 94.574 930.37, 94.483 930.325, 94.394 930.275, 94.308 930.221, 94.224 930.163, 94.144 930.101, 94.067 930.034, 93.994 929.964, 93.924 929.89, 93.858 929.813, 93.796 929.732, 93.738 929.649, 93.685 929.562, 93.636 929.473, 93.591 929.382, 93.552 929.288, 93.517 929.193, 93.487 929.096, 93.462 928.997, 93.442 928.898, 93.427 928.797, 93.417 928.696, 93.412 928.595, 93.413 928.493, 93.419 928.391, 93.429 928.29, 93.727 926.049, 93.755 925.89, 93.796 925.733, 93.849 925.579, 93.915 925.431, 93.992 925.288, 94.081 925.152, 94.181 925.024, 94.29 924.905, 94.292 924.902, 91.428 905.295, 91.411 905.297, 91.269 905.305, 91.127 905.302, 79.324 904.704, 79.222 904.697, 79.121 904.684, 79.021 904.666, 78.922 904.643, 78.824 904.615, 78.728 904.582, 78.634 904.544, 78.541 904.501, 78.451 904.454, 78.364 904.402, 78.279 904.346, 78.197 904.286, 78.118 904.221, 78.043 904.153, 77.971 904.081, 77.903 904.005, 77.839 903.926, 77.779 903.844, 77.724 903.758, 77.672 903.671, 77.626 903.58, 77.584 903.488, 77.546 903.393, 77.514 903.297, 77.486 903.199, 77.464 903.099, 77.446 902.999, 77.434 902.898, 77.427 902.797, 77.425 902.695, 77.428 902.593, 77.437 902.492, 77.683 900.217, 74.343 901.496, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 63.291 914.361, 73.036 899.855, 80.022 897.18, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 79.736 888.304, 98.4 883.585), (97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823), (88.909 888.047, 83.17 889.498, 90.523 899.096, 88.909 888.047), (101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06))',0),
 *              1,
 *              0
 *           ).AsTextZM() as gCollection;
 *    GO
 *    
 *    gCollection
 *    GEOMETRYCOLLECTION (LINESTRING (97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823), LINESTRING (88.909 888.047, 83.17 889.498, 90.523 899.096, 88.909 888.047), LINESTRING (101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06), LINESTRING (101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06))
 *    
 *    select [$(owner)].[STForceCollection](
 *             geometry::STGeomFromText('POLYGON ((97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823))',0),               
 *             1,
 *             1
 *           ).STAsText() as gCollection;
 * 
 *    gCollection
 *    MULTILINESTRING ((97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823))
 *  AUTHOR
 *    Simon Greener
 *  HISTORY
 *    Simon Greener - Oct 2019 - Original coding (Oracle).
 *  COPYRIGHT
 *    (c) 2012-2019 by TheSpatialDBAdvisor/Simon Greener
 *  LICENSE
 *      Creative Commons Attribution-Share Alike 2.5 Australia License.
 *      http://creativecommons.org/licenses/by-sa/2.5/au/
******/
Begin
  DECLARE
    @v_wkt             varchar(max),
    @v_ring_wkt        varchar(max),
    @v_linestrings     integer,
    @v_multilinestring integer,
   @v_egeom           geometry,
    @v_return_geom     geometry;
  BEGIN
    IF (@p_polygon is null ) 
     Return @p_polygon;
   IF (@p_polygon.STGeometryType() <> 'Polygon' )
     Return @p_polygon;
    SET @v_multilinestring = COALESCE(@p_multilinestring,0);
    SET @v_linestrings     = case when @v_multiLineString = 1
                                  then 1
                                  else COALESCE(@p_linestrings,0)
                              end;
    SET @v_wkt = case when @v_multilinestring = 0 
                      then 'GEOMETRYCOLLECTION('
                      else 'MULTILINESTRING('
                  end;

    DECLARE cExplodeRings
     CURSOR FAST_FORWARD 
        FOR
     SELECT e.Geom as eGeom
      FROM [$(owner)].[STExplode] (@p_polygon) as e;

    OPEN cExplodeRings;

    FETCH NEXT 
     FROM cExplodeRings 
     INTO @v_egeom;
           
    -- Check if any filtered segments were returned.
    -- 
    IF ( @@FETCH_STATUS <> 0 ) 
    BEGIN
      -- Nothing to do.
      CLOSE      cExplodeRings;
      DEALLOCATE cExplodeRings;
      RETURN NULL; 
    END;

    WHILE ( @@FETCH_STATUS = 0 )
    BEGIN
      IF ( @v_eGeom is not null ) 
      BEGIN
        SET @v_ring_wkt = @v_egeom.AsTextZM();
        IF ( @v_multilinestring = 1 )
        BEGIN
          SET @v_ring_wkt = REPLACE(REPLACE(REPLACE(@v_egeom.AsTextZM(),'POLYGON ((','('),')),((','),('),'))',')');
        END
        ELSE
        BEGIN
          IF ( @v_linestrings = 1 )
            SET @v_ring_wkt = REPLACE(REPLACE(REPLACE(@v_egeom.AsTextZM(),'POLYGON ((','LINESTRING ('),')),((','),('),'))',')');
        END;
        SET @v_wkt = @v_wkt + 
                     CASE WHEN ( @v_wkt not in ('GEOMETRYCOLLECTION(','MULTILINESTRING(') ) THEN ',' ELSE '' END +
                     @v_ring_WKT;
      END;
      FETCH NEXT 
       FROM cExplodeRings 
       INTO @v_eGeom;
    END;
    CLOSE      cExplodeRings;
    DEALLOCATE cExplodeRings;
    SET @v_return_geom = geometry::STGeomFromText(
                                    case when @v_wkt IS NULL OR @v_wkt = 'GEOMETRYCOLLECTION('  
                                         then 'GEOMETRYCOLLECTION EMPTY'
                                         when @v_wkt = 'MULTILINESTRING('
                                         then 'MULTILINESTRING EMPTY'
                                         else @v_wkt + ')'
                                     end,
                                     @p_polygon.STSrid
                                 );
    RETURN @v_return_geom;
  END;
End
go

PRINT '=============================================================='
PRINT 'Testing Conversion of Polygon with holes to GEOMETRYCOLLECTION'
go

select [$(owner)].[STForceCollection](
             geometry::STGeomFromText('POLYGON ((98.4 883.585, 115.729 903.305, 102.284 923.025, 99.148 899.272, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 96.606 926.91, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 119.017 922.28, 119.724 924.15, 101.945 930.873, 101.842 930.909, 101.737 930.939, 101.63 930.963, 101.522 930.982, 101.413 930.994, 101.304 931.001, 101.194 931.002, 101.085 930.996, 95.259 930.548, 95.158 930.538, 95.057 930.522, 94.958 930.502, 94.859 930.476, 94.762 930.446, 94.667 930.41, 94.574 930.37, 94.483 930.325, 94.394 930.275, 94.308 930.221, 94.224 930.163, 94.144 930.101, 94.067 930.034, 93.994 929.964, 93.924 929.89, 93.858 929.813, 93.796 929.732, 93.738 929.649, 93.685 929.562, 93.636 929.473, 93.591 929.382, 93.552 929.288, 93.517 929.193, 93.487 929.096, 93.462 928.997, 93.442 928.898, 93.427 928.797, 93.417 928.696, 93.412 928.595, 93.413 928.493, 93.419 928.391, 93.429 928.29, 93.727 926.049, 93.755 925.89, 93.796 925.733, 93.849 925.579, 93.915 925.431, 93.992 925.288, 94.081 925.152, 94.181 925.024, 94.29 924.905, 94.292 924.902, 91.428 905.295, 91.411 905.297, 91.269 905.305, 91.127 905.302, 79.324 904.704, 79.222 904.697, 79.121 904.684, 79.021 904.666, 78.922 904.643, 78.824 904.615, 78.728 904.582, 78.634 904.544, 78.541 904.501, 78.451 904.454, 78.364 904.402, 78.279 904.346, 78.197 904.286, 78.118 904.221, 78.043 904.153, 77.971 904.081, 77.903 904.005, 77.839 903.926, 77.779 903.844, 77.724 903.758, 77.672 903.671, 77.626 903.58, 77.584 903.488, 77.546 903.393, 77.514 903.297, 77.486 903.199, 77.464 903.099, 77.446 902.999, 77.434 902.898, 77.427 902.797, 77.425 902.695, 77.428 902.593, 77.437 902.492, 77.683 900.217, 74.343 901.496, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 63.291 914.361, 73.036 899.855, 80.022 897.18, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 79.736 888.304, 98.4 883.585), (97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823), (88.909 888.047, 83.17 889.498, 90.523 899.096, 88.909 888.047), (101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06))',0),
          0,
          0
       ).AsTextZM() as gCollection;
GO

select [$(owner)].[STForceCollection](
             geometry::STGeomFromText('POLYGON ((98.4 883.585, 115.729 903.305, 102.284 923.025, 99.148 899.272, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 110.8 902.707, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 90.78 887.02, 96.606 926.91, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.71 926.313, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 95.412 928.554, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 101.238 929.002, 119.017 922.28, 119.724 924.15, 101.945 930.873, 101.842 930.909, 101.737 930.939, 101.63 930.963, 101.522 930.982, 101.413 930.994, 101.304 931.001, 101.194 931.002, 101.085 930.996, 95.259 930.548, 95.158 930.538, 95.057 930.522, 94.958 930.502, 94.859 930.476, 94.762 930.446, 94.667 930.41, 94.574 930.37, 94.483 930.325, 94.394 930.275, 94.308 930.221, 94.224 930.163, 94.144 930.101, 94.067 930.034, 93.994 929.964, 93.924 929.89, 93.858 929.813, 93.796 929.732, 93.738 929.649, 93.685 929.562, 93.636 929.473, 93.591 929.382, 93.552 929.288, 93.517 929.193, 93.487 929.096, 93.462 928.997, 93.442 928.898, 93.427 928.797, 93.417 928.696, 93.412 928.595, 93.413 928.493, 93.419 928.391, 93.429 928.29, 93.727 926.049, 93.755 925.89, 93.796 925.733, 93.849 925.579, 93.915 925.431, 93.992 925.288, 94.081 925.152, 94.181 925.024, 94.29 924.905, 94.292 924.902, 91.428 905.295, 91.411 905.297, 91.269 905.305, 91.127 905.302, 79.324 904.704, 79.222 904.697, 79.121 904.684, 79.021 904.666, 78.922 904.643, 78.824 904.615, 78.728 904.582, 78.634 904.544, 78.541 904.501, 78.451 904.454, 78.364 904.402, 78.279 904.346, 78.197 904.286, 78.118 904.221, 78.043 904.153, 77.971 904.081, 77.903 904.005, 77.839 903.926, 77.779 903.844, 77.724 903.758, 77.672 903.671, 77.626 903.58, 77.584 903.488, 77.546 903.393, 77.514 903.297, 77.486 903.199, 77.464 903.099, 77.446 902.999, 77.434 902.898, 77.427 902.797, 77.425 902.695, 77.428 902.593, 77.437 902.492, 77.683 900.217, 74.343 901.496, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 64.95 915.476, 63.291 914.361, 73.036 899.855, 80.022 897.18, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 79.425 902.707, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 91.228 903.305, 79.736 888.304, 98.4 883.585), (97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823), (88.909 888.047, 83.17 889.498, 90.523 899.096, 88.909 888.047), (101.533 902.06, 103.581 917.573, 113.204 903.46, 112.781 902.979, 112.78 902.988, 112.762 903.094, 112.739 903.199, 112.71 903.302, 112.675 903.403, 112.635 903.503, 112.59 903.6, 112.539 903.695, 112.484 903.787, 112.423 903.875, 112.358 903.961, 112.289 904.042, 112.215 904.12, 112.137 904.194, 112.056 904.264, 111.97 904.329, 111.882 904.389, 111.79 904.445, 111.695 904.495, 111.598 904.541, 111.499 904.581, 111.397 904.616, 111.294 904.645, 111.19 904.669, 111.084 904.687, 110.977 904.699, 110.87 904.706, 110.763 904.707, 110.656 904.702, 110.549 904.691, 110.443 904.675, 110.338 904.653, 110.234 904.625, 101.533 902.06))',0),
          1,
          0
       ).AsTextZM() as gCollection;
GO

PRINT 'Testing Conversion of Polygon with holes to MULTILINESTRING'
go

select [$(owner)].[STForceCollection](
          geometry::STGeomFromText('POLYGON ((97.705 885.823, 93.766 886.819, 109.224 898.931, 97.705 885.823))',0),               
          1,
          1
       ).STAsText()  as gCollection;

QUIT;
