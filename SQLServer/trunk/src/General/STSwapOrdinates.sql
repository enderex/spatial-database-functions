SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

PRINT '******************************************************************';
PRINT 'Database Schema Variables are: Owner($(cogoowner)) owner($(owner))';
GO

IF EXISTS (SELECT * 
             FROM sys.objects
            WHERE object_id = OBJECT_ID(N'[$(owner)].[STSwapOrdinates]') 
              AND type in (N'FN', N'IF', N'TF', N'FS', N'FT')
)
BEGIN
  DROP FUNCTION [$(owner)].[STSwapOrdinates];
  PRINT 'Dropping [$(owner)].[STSwapOrdinates] ...';
END;
GO

PRINT 'Creating [$(owner)].[STSwapOrdinates] ...';
GO

CREATE FUNCTION [$(owner)].[STSwapOrdinates]
(
  @p_geometry  geometry,
  @p_swap      varchar(2) = 'XY'
)
Returns geometry
As
/****f* EDITOR/STSwapOrdinates (2008)
 *  NAME
 *    STSwapOrdinates -- Allows for swapping ordinate pairs in a geometry.
 *  SYNOPSIS
 *    Function STSwapOrdinates (
 *               @p_geometry geometry,
 *               @p_swap     varchar(2) = 'XY'
 *             )
 *     Returns geometry 
 *  DESCRIPTION
 *    Sometimes the ordinates of a geometry can be swapped such as latitude for X
 *    and Longitude for Y when it should be reversed. This function allows for the
 *    swapping of pairs of ordinates controlled by the @p_swap parameter.
 *    Also supports Z and M ordinate values.
 *  INPUTS
 *    @p_geometry (geometry)  - Supplied geometry.
 *    @p_swap     (varchar 2) - The ordinate pair to swap: XY, XZ, XM, YZ, YM or ZM
 *  RESULT
 *    altered geom (geometry) - Changed Geometry;
 *  EXAMPLE
 *    SELECT [$(owner)].[STSwapOrdinates] (
 *             geometry::STPointFromText('POINT(143.282374 20.293874)',4326),
 *             'XY'
 *           ).AsTextZM() as correctedOrdinates;
 *    correctedOrdinates
 *    POINT (20.293874 143.282374)
 *  AUTHOR
 *    Simon Greener
 *  HISTORY
 *    Simon Greener - August 2009 - Original TSQL Coding for SQL Spatial.
 *  COPYRIGHT
 *    (c) 2008-2018 by TheSpatialDBAdvisor/Simon Greener
******/
Begin
  Declare
     @v_coord    int = 0,
     @v_rows     int = 0,
     @v_wkt      varchar(max) = '',
     @v_token    varchar(max),
     @v_delim    varchar(max),
     @v_temp     varchar(100),
     @v_x        varchar(100),
     @v_y        varchar(100),
     @v_z        varchar(100),
     @v_m        varchar(100),
     @v_geometry geometry;
  Begin
    If ( @p_geometry is NULL ) 
      Return null;
    If ( @p_swap NOT IN ('XY','YX', 'XZ', 'XM', 'YZ', 'YM', 'ZM') )
      RETURN CONCAT('POINT(',@p_swap,' must be one of XY, YX, XZ, XM, YZ, YM, ZM only)');
    Set @v_coord = 0;
    Set @v_rows  = 0;
    DECLARE Tokens CURSOR FAST_FORWARD FOR
      SELECT t.token, t.separator
        FROM [$(owner)].[TOKENIZER](@p_geometry.AsTextZM(),' ,()') as t;
    OPEN Tokens;
    FETCH NEXT 
          FROM Tokens
          INTO @v_token, @v_delim;
    WHILE @@FETCH_STATUS = 0
    BEGIN
       IF ( @v_token is null )  -- double delimiter
       BEGIN
          SET @v_wkt = @v_wkt + @v_delim
       END
       ELSE
       BEGIN
          IF ( @v_token not like '[-0-9]%' and @v_token <> 'NULL' ) 
          BEGIN
             SET @v_wkt = @v_wkt + @v_token + LTRIM(@v_delim)
          END
          ELSE -- @v_token LIKE '[0-9]%' or @v_token = 'NULL'
          BEGIN
             SET @v_coord = @v_coord + 1;
             IF ( @v_coord = 1 ) SET @v_x = @v_token
             IF ( @v_coord = 2 ) SET @v_y = @v_token
             IF ( @v_coord = 3 ) SET @v_z = @v_token
             IF ( @v_coord = 4 ) SET @v_m = @v_token
             IF ( @v_delim in (',',')') )
             BEGIN
               IF ( @p_swap IN ('XY','YX') ) 
               BEGIN
                 SET @v_temp = @v_y;
                 SET @v_y    = @v_x;
                 SET @v_x    = @v_temp;
               END
               ELSE IF ( @p_swap = 'XZ')
               BEGIN
                 SET @v_temp = @v_z;
                 SET @v_z    = @v_x;
                 SET @v_x    = @v_temp;
               END
               ELSE IF ( @p_swap = 'XM' )
               BEGIN
                 SET @v_temp = @v_m;
                 SET @v_m    = @v_x;
                 SET @v_x    = @v_temp;
               END
               ELSE IF ( @p_swap = 'YZ' )
               BEGIN
                 SET @v_temp = @v_y;
                 SET @v_y    = @v_z;
                 SET @v_z    = @v_temp;
               END
               ELSE IF ( @p_swap = 'YM' )
               BEGIN
                 SET @v_temp = @v_y;
                 SET @v_y    = @v_m;
                 SET @v_m    = @v_temp;
               END
               ELSE IF ( @p_swap = 'ZM' )
               BEGIN
                 SET @v_temp = @v_z;
                 SET @v_z    = @v_m;
                 SET @v_m    = @v_temp;
               END
               SET @v_wkt = CONCAT(@v_wkt,
                                   @v_x,' ',
                                   @v_y,
                                   CASE WHEN @v_z is null THEN '' ELSE CONCAT(' ',@v_z) END,
                                   CASE WHEN @v_m is null THEN '' ELSE CONCAT(' ',@v_m) END,
                                   @v_delim);
               SET @v_coord = 0;
             END;
           END;
       END;
       FETCH NEXT FROM Tokens INTO @v_token, @v_delim;
    END;
    CLOSE Tokens
    DEALLOCATE Tokens
    -- RETURN @v_wkt;
    SET @v_geometry = geometry::STGeomFromText(@v_wkt,@p_geometry.STSrid);
    RETURN @v_geometry;
  End
End
GO

Print 'Testing ....';
Print 'ZM ordinate with NULLs....';
GO

select [$(owner)].[STSwapOrdinates](geometry::STGeomFromText('LINESTRING (-32 140 NULL 2, -33 141 NULL 3)',0),'XY').AsTextZM() as sGeom
GO

Print 'GML test ....';
GO

/*
declare @geom geometry;
SET @geom = geometry::GeomFromGml('<LineString xmlns="http://www.opengis.net/gml"><posList>147.775364306 -20.49918551  147.776402476 -20.500021717  147.778202959 -20.5015774579999  147.784126062 -20.502441614  147.788495807 -20.5030791409999  147.791938864 -20.5035814679999  147.796053721 -20.5041818079999  147.799557131 -20.5046929399999  147.803656206 -20.5052909779999  147.811130896 -20.5063815029999  147.814175528 -20.5061210069999  147.818354204 -20.505763483  147.821832664 -20.5054658679999  147.825805453 -20.5051259599999  147.83094753 -20.504686008  147.833391163 -20.5044793979999  147.836068876 -20.5053712939999  147.840567054 -20.506869953  147.843841613 -20.507961075  147.846878353 -20.508972953  147.848649872 -20.512749722  147.850121601 -20.5158873569999  147.853179366 -20.52240632  147.854918619 -20.526114299  147.85624312 -20.5289380519999  147.858034344 -20.532756832  147.859559244 -20.5360078219999  147.860171928 -20.537314027  147.861099831 -20.539292216  147.862666733 -20.5426326809999  147.86420318 -20.545908219  147.865841162 -20.5494002189999  147.867312917 -20.5525378419999  147.868567492 -20.5552124609999  147.871573379 -20.561620686  147.872172376 -20.5634051769999  147.873552401 -20.5663454209999  147.875057451 -20.56955204  147.876256222 -20.5721061089999  147.877701453 -20.575185279  147.879090427 -20.578144591  147.880551074 -20.581256606  147.882073425 -20.5845000859999  147.883511878 -20.5878177339999  147.885040318 -20.591342929  147.885742474 -20.5929623819999  147.887018844 -20.5959062009999  147.888370797 -20.599024346  147.889534261 -20.601707759  147.890771311 -20.6045608919999  147.891657004 -20.606603654  147.892909004 -20.609491267  147.894729211 -20.6134196359999  147.896063045 -20.616355127  147.89772734 -20.6200178939999  147.899543518 -20.6240149239999  147.901426693 -20.628159328  147.90409208 -20.6340251569999  147.905146985 -20.6363467309999  147.907074635 -20.64058899  147.908969337 -20.6447587389999  147.910942528 -20.6491012229999  147.912762226 -20.653105906  147.913808554 -20.6554086049999  147.915483867 -20.6590955349999  147.9170539 -20.662550772  147.918870381 -20.6665483789999  147.920098871 -20.669251967  147.921458619 -20.67224442  147.92296195 -20.675552863  147.924645565 -20.6792580659999  147.926102822 -20.6824651119999  147.927346847 -20.68520289  147.92869106 -20.688161153  147.930052684 -20.691157737  147.93157075 -20.694498606  147.932932105 -20.6974945979999  147.934644114 -20.701262287  147.936229419 -20.7047511329999  147.937612741 -20.707795468  147.93927546 -20.711454682  147.940822725 -20.7148598119999  147.942165329 -20.717814538  147.943686341 -20.7211618919999  147.945184048 -20.724457957  147.946669967 -20.72772808  147.948321704 -20.7313631289999  147.949825304 -20.734672163  147.951811353 -20.739042943  147.953902945 -20.7436459969999  147.955496284 -20.7471525239999  147.956918717 -20.750282931  147.958498128 -20.753758806  147.959884128 -20.7568090349999  147.961430856 -20.7602129819999  147.962871238 -20.763382892  147.964359835 -20.7666589089999  147.965802627 -20.769834121  147.967175501 -20.7728554619999  147.968622847 -20.7760406969999  147.970022243 -20.779120405  147.971624154 -20.7826457959999  147.973032121 -20.7857443689999  147.974514023 -20.789005652  147.976008782 -20.792295231  147.977518276 -20.7956172359999  147.979024826 -20.798932755  147.98054852 -20.802286001  147.982049177 -20.8055885489999  147.983655646 -20.8091239619999  147.985478026 -20.8131345369999  147.987236113 -20.81700362  147.988928573 -20.820728276  147.990442356 -20.824059712  147.991884614 -20.827233739  147.993382593 -20.8305303929999  147.994866375 -20.833795805  147.996349888 -20.8370606249999  147.997895011 -20.840461031  147.999378525 -20.8437258509999  148.000904897 -20.847084991  148.002506811 -20.850610381  148.004010684 -20.853920005  148.006959345 -20.8604092269999  148.009100347 -20.863305625  148.011111411 -20.866026239  148.013513239 -20.869275488  148.015930841 -20.8725460759999  148.017696517 -20.874934724  148.019164284 -20.8769203529999  148.021755723 -20.880426112  148.023845004 -20.8832525399999  148.026019821 -20.886194684  148.028235618 -20.889192265  148.030382466 -20.89209657  148.032614036 -20.89511549  148.035166446 -20.898568451  148.037330205 -20.901495634  148.03955706 -20.9045081749999  148.041726348 -20.9074428389999  148.043914175 -20.910402582  148.046117776 -20.913383664  148.048195837 -20.916194914  148.050478631 -20.9192831299999  148.052553927 -20.92209064  148.054730696 -20.9250354229999  148.056917385 -20.927993627  148.058902592 -20.930679262  148.061363938 -20.9340090269999  148.063557294 -20.9369762499999  148.065724793 -20.939908493  148.068020272 -20.9430138719999  148.070039792 -20.945745925  148.071971011 -20.948358523  148.074341291 -20.9515650929999  148.078653526 -20.957398784  148.081016326 -20.960595235  148.08303113 -20.9633209089999  148.085258146 -20.9663336689999  148.087349055 -20.9691622989999  148.089555582 -20.9721473399999  148.091658687 -20.974992469  148.093859523 -20.977969811  148.096082799 -20.9809775109999  148.098252087 -20.9839121749999  148.100408366 -20.986829239  148.102582208 -20.989770063  148.104770035 -20.9927298059999  148.106927128 -20.995647971  148.109142924 -20.998645552  148.11130831 -21.0015749369999  148.113509308 -21.004552498  148.115630138 -21.0074216049999  148.118324998 -21.0110672759999  148.121253213 -21.0150286329999  148.123502508 -21.018071531  148.125209319 -21.020380545  148.127363647 -21.0232949699999  148.129395362 -21.026043522  148.131438136 -21.028807033  148.133864032 -21.032088842  148.135930873 -21.0348849129999  148.13810943 -21.0378321159999  148.140315796 -21.040816938  148.142547528 -21.043836077  148.144409832 -21.046355446  148.147061765 -21.049942968  148.149132535 -21.0527442969999  148.151389179 -21.0557970739999  148.153482634 -21.0586290909999  148.15617845 -21.061077403  148.159680714 -21.064258122  148.16254362 -21.066858183  148.165323135 -21.06938251  148.168044984 -21.071854464  148.170849437 -21.07440144  148.173424802 -21.0767403589999  148.185070429 -21.0873167949999  148.188158136 -21.090121019  148.190467004 -21.0922179089999  148.192811705 -21.0943473419999  148.195550705 -21.096834873  148.197929314 -21.098995101  148.200513255 -21.101341808  148.203706931 -21.104242272  148.206679189 -21.1069416449999  148.209816433 -21.10986996  148.212771322 -21.1126280629999  148.214996132 -21.114704708  148.218055279 -21.1175601259999  148.220702135 -21.120030711  148.223753477 -21.122878843  148.227619088 -21.126487018  148.22916064 -21.1279259189999  148.231694587 -21.130291132  148.234538519 -21.1329456899999  148.237094621 -21.1353315819999  148.238795079 -21.137924433  148.241042126 -21.1413507189999  148.243603055 -21.145255613  148.245527574 -21.14819011  148.247641211 -21.1514129729999  148.249552379 -21.154327113  148.251620955 -21.157481269  148.253820238 -21.160834726  148.256215815 -21.1644874899999  148.25852698 -21.168011544  148.260084913 -21.170387072  148.261953397 -21.1732361269999  148.264782359 -21.1775497159999  148.266851821 -21.180705221  148.268796399 -21.183670306  148.270718448 -21.1866010369999  148.272867732 -21.1898782549999  148.274905367 -21.192985231  148.276864299 -21.195972201  148.278846995 -21.1989954059999  148.280641575 -21.2017317729999  148.282354212 -21.204343196  148.284510673 -21.2076313539999  148.286824329 -21.21115916  148.289278339 -21.214900975  148.291472936 -21.218247242  148.292893397 -21.220413127  148.295402689 -21.224239294  148.297186618 -21.2269594279999  148.299485897 -21.230465366  148.301212767 -21.233098496  148.303395458 -21.2364266609999  148.30544821 -21.239556696  148.307414314 -21.24255461  148.309446397 -21.245653127  148.311354813 -21.2485630859999  148.313518442 -21.251862193  148.315387014 -21.254711395  148.317426879 -21.257821787  148.319451157 -21.2609084109999  148.321457611 -21.2639678579999  148.323416419 -21.266954653  148.325684753 -21.270413414  148.327962734 -21.273886884  148.329987128 -21.276973686  148.331726996 -21.279626642  148.333800156 -21.2827877999999  148.335656845 -21.285618885  148.337729887 -21.288779865  148.339408107 -21.291338819  148.341802325 -21.294989528  148.343575604 -21.2976934279999  148.34572735 -21.300974417  148.347613746 -21.3038507969999  148.34970361 -21.3070374279999  148.351413656 -21.30964491  148.353701049 -21.3131327319999  148.357725956 -21.3192699209999  148.359646764 -21.322198773  148.360590397 -21.323637628  148.361671145 -21.325285585  148.363651339 -21.328305045  148.365797117 -21.3315769929999  148.367619254 -21.3343554429999  148.369659093 -21.337465852  148.37153929 -21.3403328319999  148.376184309 -21.347415698  148.377852745 -21.3499597799999  148.379455307 -21.352403416  148.384325026 -21.3579435249999  148.386783893 -21.360740893  148.388908355 -21.363157819  148.391104309 -21.36565608  148.393198671 -21.368038762  148.398263617 -21.3738009749999  148.400429472 -21.376264992  148.40307976 -21.379280133  148.40575145 -21.382319621  148.408175275 -21.385077123  148.410537963 -21.3877650699999  148.413021048 -21.39058999  148.415120822 -21.3929788299999  148.418087872 -21.396354339  148.420853394 -21.399500577  148.425328434 -21.4045916749999  148.427379995 -21.406925663  148.430680512 -21.410680547  148.432701033 -21.412979224  148.435544745 -21.416214415  148.437733878 -21.418704916  148.440163585 -21.4214691089999  148.44244067 -21.424059669  148.444960206 -21.4269260569999  148.447280092 -21.429565311  148.449875939 -21.432518516  148.452356677 -21.435340765  148.454416087 -21.437683684  148.454772743 -21.438089439  148.457320034 -21.440987397  148.45962722 -21.443612198  148.462187213 -21.446524607  148.464375879 -21.449014572  148.466843448 -21.4518218339999  148.469369807 -21.454695979  148.471784936 -21.4574435829999  148.474070252 -21.460043502  148.476729366 -21.463068678  148.479056075 -21.465715689  148.481539163 -21.468540607  148.483925601 -21.47125557  148.486341669 -21.474004242  148.489020652 -21.477052021  148.491335597 -21.479685649  148.493775068 -21.482460945  148.496303899 -21.485337903  148.498943959 -21.4883414019999  148.501274548 -21.490992827  148.503528356 -21.493556901  148.505974054 -21.496339282  148.508374603 -21.4990702979999  148.510804782 -21.501835023  148.513214969 -21.5045770039999  148.515674309 -21.507374904  148.518110839 -21.510146854  148.520567707 -21.5129419429999  148.523048917 -21.515764724  148.525497087 -21.5185499159999  148.527936434 -21.521325071  148.530351096 -21.5240721389999  148.532817728 -21.526878331  148.535183707 -21.529570013  148.539962939 -21.535007161  148.542451911 -21.537838768  148.544499595 -21.5401683389999  148.549388179 -21.5457298919999  148.552747493 -21.549551654  148.556762325 -21.5541191729999  148.559179334 -21.556868911  148.561273229 -21.559251058  148.563980886 -21.5623314919999  148.56634156 -21.5650171729999  148.568545262 -21.567524271  148.571041976 -21.570364722  148.573493071 -21.5731532729999  148.575876555 -21.575864903  148.578366448 -21.578697593  148.580766043 -21.581427554  148.583247238 -21.5842503489999  148.586046136 -21.587434575  148.588166889 -21.5898471859999  148.590525625 -21.592530532  148.591838587 -21.5940241829999  148.593101156 -21.595460584  148.595418084 -21.598096507  148.597943013 -21.600969069  148.600923212 -21.604359584  148.602417382 -21.6060595229999  148.603982978 -21.6065856659999  148.608155731 -21.607987194  148.612551145 -21.609463509  148.616203042 -21.6106900939999  148.62341307 -21.6131117699999  148.628134535 -21.6146976209999  148.631465083 -21.6158163219999  148.634814415 -21.616941332  148.638717265 -21.618252264  148.642352775 -21.619473399  148.645798233 -21.620630698  148.649489991 -21.6218707259999  148.651031975 -21.622388664  148.653059722 -21.623069879  148.65657988 -21.6242524649999  148.661167587 -21.625713853  148.664444559 -21.6267577149999  148.667420783 -21.6277057739999  148.671715647 -21.629074042  148.675850886 -21.6303914549999  148.679370771 -21.6315128279999  148.682570946 -21.630304399  148.683198741 -21.6317266569999</posList></LineString>',4283)
select [$(owner)].[STSwapOrdinates](@geom,'XY').AsTextZM() as sGeom
GO
*/


