-- FUNCTION: spdba.st_line_offset(geometry, double precision)

-- DROP FUNCTION IF EXISTS spdba.st_line_offset(geometry, double precision);

CREATE OR REPLACE FUNCTION spdba.ST_Line_Offset(
  p_geometry      geometry,
  p_offset double precision
)
RETURNS geometry
LANGUAGE 'plpgsql'
COST 100
IMMUTABLE 
AS $BODY$
Declare
  v_id          integer;
  v_geomType    varchar(100);
  v_geometry    geometry;
  v_geomn       geometry;
  v_geomo       geometry;
  v_build_geom  geometry;
  v_return_geom geometry;
Begin
  IF ( p_geometry is null or p_offset is null) THEN
    RETURN p_geometry;
  END IF;
  v_geomType := ST_GeometryType(p_geometry);
  IF ( v_geomType NOT IN ('ST_LineString','ST_MultiLineString','ST_GeometryCollection') ) THEN
    RETURN null;
  END IF;

  IF ( v_geomType = 'ST_LineString' ) Then
    IF ( ST_IsSimple(p_geometry) ) THEN
      Return ST_OffsetCurve(p_geometry,p_offset);
	END IF;
  END IF;
  
  -- Break into individual vertex-to-vertex segments and save to GeometryCollection for processing later on
  SELECT ST_Collect(a.segment)
    INTO v_geometry
	FROM (SELECT v.segment
            FROM spdba.ST_VectorAsSegment(p_geometry) as v
           ORDER BY v.id
          ) as a;
  
  -- Now process elements
  v_build_geom  := NULL;
  v_return_geom := NULL;
  FOR v_id in 1..ST_NumGeometries(v_geometry) LOOP
    BEGIN
      v_geomn := ST_GeometryN(v_geometry,v_id);
      IF ( ST_GeometryType(v_geomn) <> 'ST_LineString' ) THEN
        CONTINUE;
      END IF;
      IF ( v_build_geom is null ) THEN
        v_build_geom := v_geomn;
        CONTINUE;
      END IF;

      IF ( ST_IsSimple(ST_MakeLine(v_build_geom,v_geomn)) ) THEN
        v_build_geom := ST_MakeLine(v_build_geom,v_geomn);
        IF ( v_id <> ST_NumGeometries(v_geometry) ) THEN
          CONTINUE;
        END IF;
      END IF;
      
      -- We need to offset and start again
      v_geomo := ST_OffsetCurve(v_build_geom,p_offset);
      IF ( v_return_geom is null ) THEN
        v_return_geom := v_geomo;
      ELSE
        v_return_geom := ST_MakeLine(v_return_geom,v_geomo);
      END IF;
      v_build_geom := v_geomn;
      EXCEPTION 
        WHEN OTHERS THEN
          RAISE NOTICE 'ST_OffsetCurve failed with %',SQLERRM ;
    END;
  END LOOP;
  RETURN v_return_geom;
End;
$BODY$;

ALTER FUNCTION spdba.st_line_offset(geometry, double precision)
    OWNER TO postgres;

select spdba.st_line_offset(
ST_GeomFromText('
GEOMETRYCOLLECTION(
LINESTRING(501281.420661861 6976832.66107578,501281.602219663 6976832.66257082,501281.750013879 6976832.73447071,501282.25288796 6976839.00706141,501282.283036163 6976839.26195076,501282.343332569 6976839.46476594,501282.413298223 6976839.67083691,501282.494073583 6976839.83750736,501282.598221921 6976839.99098912,501282.729777715 6976840.07047075,501282.897588914 6976840.10787973,501283.080593167 6976840.13076715,501283.256000893 6976840.1335079,501283.735631394 6976840.11706343,501284.134883719 6976840.10757201),
LINESTRING(501256.656528639 6976837.34630941,501257.918427666 6976837.12262744,501264.649823658 6976835.72630497,501275.578606756 6976833.61724157,501281.420661861 6976832.66107578),
LINESTRING(501256.656528639 6976837.34630941,501256.112361885 6976837.56431574,501254.169858356 6976837.91697263,501225.792155763 6976842.62484576),
LINESTRING(501225.792155763 6976842.62484576,501188.093198389 6976848.53663428,501188.08908727 6976848.53663428),
LINESTRING(501188.08908727 6976848.53663428,501187.94519812 6976848.55924543,501187.254530199 6976848.43591187,501186.588528989 6976848.21391147,501183.866968489 6976846.79968668,501182.658299627 6976846.37213035,501181.548297611 6976846.26729682),
LINESTRING(501181.548297611 6976846.26729682,501131.524206735 6976854.68686767),
LINESTRING(501131.524206735 6976854.68686767,501130.026792015 6976854.98170442,501128.660969221 6976855.53182749,501126.356143257 6976856.80280148,501124.810107733 6976858.20656379,501124.022862651 6976859.20247625,501123.909044085 6976859.58898513),
LINESTRING(501123.909044085 6976859.58898513,501111.856615451 6976863.62443946,501105.091041149 6976865.53837643,501097.768713394 6976867.24565492,501082.554965054 6976869.74966337,501078.723073327 6976870.67918166,501076.769187942 6976871.47591163,501075.08087921 6976872.68997633,501073.734026178 6976874.43519435,501072.766568366 6976876.33217045,501072.330263862 6976878.11532798,501072.007777925 6976880.05024361),
LINESTRING(501072.007777925 6976880.05024361,501059.070400907 6976881.68164306),
LINESTRING(501059.070400907 6976881.68164306,501058.440117457 6976880.6662339,501057.116515521 6976879.32939269,501054.745295393 6976877.39447707,501052.487893832 6976876.29423093,501049.49067159 6976875.45956144,501045.089687032 6976875.26986383),
LINESTRING(501045.089687032 6976875.26986383,501008.950513868 6976879.57066434,500992.940035564 6976882.68170515,500961.450232266 6976890.26960956),
LINESTRING(500961.450232266 6976890.26960956,500933.982018304 6976896.33993308,500916.757475295 6976902.33437757),
LINESTRING(500916.757475295 6976902.33437757,500867.587854722 6976910.35858648,500865.159725311 6976910.81386074,500863.110991121 6976911.64853023,500862.406244783 6976912.21614103,500862.190957711 6976913.06177742),
LINESTRING(500862.190957711 6976913.06177742,500854.141054783 6976908.59863713),POINT(500862.190957711 6976913.06177742),
LINESTRING(500854.141054783 6976908.59863713,500853.815808219 6976909.78949365,500848.921609876 6976914.22841773,500848.509116419 6976914.9214068,500848.541127891 6976915.73236408),
LINESTRING(500848.541127891 6976915.73236408,500848.477104947 6976915.97778537,500836.21186999 6976916.22972752),
LINESTRING(500836.21186999 6976916.22972752,500827.182263744 6976916.42891001),
LINESTRING(500827.182263744 6976916.42891001,500825.648479569 6976916.09427155,500820.011694077 6976913.20405063),
LINESTRING(500820.011694077 6976913.20405063,500814.643251707 6976901.02546406),
LINESTRING(500814.643251707 6976901.02546406,500798.36719675 6976903.30183538),
LINESTRING(500798.36719675 6976903.30183538,500743.84489259 6976910.93387796),
LINESTRING(500743.84489259 6976910.93387796,500740.907790612 6976911.34501405,500724.72658446 6976914.72163151,500717.366317183 6976916.04951479,500710.499263693 6976916.77036571,500694.963029415 6976918.32588611),
LINESTRING(500694.963029415 6976918.32588611,500678.319 6976918.909,500650.72554671 6976916.12539383),
LINESTRING(500650.72554671 6976916.12539383,500630.69347907 6976912.36938115,500611.078746172 6976907.55106185),
LINESTRING(500611.078746172 6976907.55106185,500560.163907587 6976895.72341585),
LINESTRING(500560.163907587 6976895.72341585,500504.260021853 6976882.6058261),
LINESTRING(500504.260021853 6976882.6058261,500479.637272046 6976877.37017206,500455.355977936 6976873.04506655),
LINESTRING(500455.355977936 6976873.04506655,500439.857683181 6976871.56542519,500419.009915817 6976870.54105809,500395.677109759 6976869.8581467),
LINESTRING(500395.677109759 6976869.8581467,500395.639170237 6976868.64408199),
LINESTRING(500395.639170237 6976868.64408199,500399.148576026 6976858.88413994),
LINESTRING(500399.148576026 6976858.88413994,500400.419148684 6976855.92715433),
LINESTRING(500400.419148684 6976855.92715433,500381.127303054 6976853.04145355),
LINESTRING(500381.127303054 6976853.04145355,500370.708501488 6976852.06577055),
LINESTRING(500370.708501488 6976852.06577055,500370.711002385 6976852.95692325,500370.537606913 6976853.90392929,500370.230830309 6976854.49080627,500368.310142005 6976857.57191042,500366.994831092 6976860.32584178),
LINESTRING(500366.994831092 6976860.32584178,500356.928211242 6976853.39555575),
LINESTRING(500356.928211242 6976853.39555575,500357.496266713 6976853.01110933,500357.81638143 6976852.16080461,500358.395206095 6976851.52387266),
LINESTRING(500358.395206095 6976851.52387266,500361.809763079 6976847.07230208),
LINESTRING(500361.809763079 6976847.07230208,500362.695018593 6976844.50506109,500362.897362711 6976842.22868977,500362.492674476 6976837.57477506,500361.733884035 6976833.1737905,500360.823335506 6976826.15497893,500359.356340653 6976818.26355834,500354.955356096 6976805.42735338),
LINESTRING(500354.955356096 6976805.42735338,500354.980649111 6976806.21143684,500354.803598008 6976806.81846919,500351.372179014 6976815.64151582,500351.068662837 6976816.38344425,500351.169834896 6976816.88930454,500351.304730975 6976817.69868101))
',28356),
0.35)
