drop function if exists  spdba.ST_Stitch(geometry,integer,integer);

create or replace function spdba.ST_Stitch(
  p_geometry geometry,
  p_round_xy integer default 8,
  p_round_zm integer default 3
)
RETURNS geometry
LANGUAGE 'plpgsql'
COST 100
IMMUTABLE 
AS $BODY$
/* Expect input p_geometry points to have coordinates already rounded via ST_SnapToNode */
Declare
  v_geomType   varchar(50);
  v_round_xy   integer := COALESCE(p_round_xy,8);
  v_round_zm   integer := COALESCE(p_round_zm,3);
  v_geometry   geometry;
  v_geomn      geometry;
  v_build_geom geometry;
Begin
  IF ( p_geometry is null) THEN
    RETURN p_geometry;
  END IF;

  v_geomType := ST_GeometryType(p_geometry);
  
  IF ( v_geomType NOT IN ('ST_LineString','ST_MultiLineString','ST_GeometryCollection') ) THEN
    RETURN p_geometry;
  END IF;

  IF ( v_geomType = 'ST_GeometryCollection' ) Then
    v_geometry := ST_CollectionExtract(p_geometry,2);
	IF ( ST_isEmpty(v_geometry) ) THEN
      Return p_geometry;
	END IF;
    v_geomType := ST_GeometryType(v_geometry);  -- Reset as has probably changed
  ELSE
    v_geometry := p_geometry;
  END IF;

  IF ( v_geomType = 'ST_LineString' ) Then
    Return v_geometry;
  ELSIF ( v_geomType = 'ST_MultiLineString' and ST_NumGeometries(v_geometry) = 1 ) THEN
    Return ST_GeometryN(v_geometry,1);
  END IF;
  
  -- Now process elements
  v_build_geom := ST_GeometryN(v_geometry,1);
  FOR i IN 2..ST_NumGeometries(v_geometry) LOOP
    v_geomn      := ST_GeometryN(v_geometry,i);
    v_build_geom := spdba.ST_Append(v_build_geom,v_geomn,v_round_xy,v_round_zm);
  END LOOP;
  RETURN v_build_geom;
End;
$BODY$;

ALTER FUNCTION spdba.ST_Stitch(geometry,integer,integer) OWNER TO postgres;

SELECT spdba.ST_Stitch(ST_GeomFromText('GEOMETRYCOLLECTION(MULTILINESTRING((0 0, 1 1),(1 1,2 2),(2 2, 3 3)),LINESTRING(10 10,11 11))'));

select sGeom, ST_GeometryType(sGeom), ST_NumGeometries(sGeom) as nGeoms 
  from (select spdba.ST_Stitch(ST_GeomFromEWKT('SRID=28356;GEOMETRYCOLLECTION(LINESTRING(501281.4207 6976832.6611,501281.6022 6976832.6626,501281.75 6976832.7345,501282.2529 6976839.0071,501282.283 6976839.262,501282.3433 6976839.4648,501282.4133 6976839.6708,501282.4941 6976839.8375,501282.5982 6976839.991,501282.7298 6976840.0705,501282.8976 6976840.1079,501283.0806 6976840.1308,501283.256 6976840.1335,501283.7356 6976840.1171,501284.1349 6976840.1076),LINESTRING(501256.6565 6976837.3463,501257.9184 6976837.1226,501264.6498 6976835.7263,501275.5786 6976833.6172,501281.4207 6976832.6611),LINESTRING(501256.6565 6976837.3463,501256.1124 6976837.5643,501254.1699 6976837.917,501225.7922 6976842.6248),LINESTRING(501225.7922 6976842.6248,501188.0932 6976848.5366,501188.0891 6976848.5366),LINESTRING(501188.0891 6976848.5366,501187.9452 6976848.5592,501187.2545 6976848.4359,501186.5885 6976848.2139,501183.867 6976846.7997,501182.6583 6976846.3721,501181.5483 6976846.2673),LINESTRING(501181.5483 6976846.2673,501131.5242 6976854.6869),LINESTRING(501131.5242 6976854.6869,501130.0268 6976854.9817,501128.661 6976855.5318,501126.3561 6976856.8028,501124.8101 6976858.2066,501124.0229 6976859.2025,501123.909 6976859.589),LINESTRING(501123.909 6976859.589,501111.8566 6976863.6244,501105.091 6976865.5384,501097.7687 6976867.2457,501082.555 6976869.7497,501078.7231 6976870.6792,501076.7692 6976871.4759,501075.0809 6976872.69,501073.734 6976874.4352,501072.7666 6976876.3322,501072.3303 6976878.1153,501072.0078 6976880.0502),LINESTRING(501072.0078 6976880.0502,501059.0704 6976881.6816),LINESTRING(501059.0704 6976881.6816,501058.4401 6976880.6662,501057.1165 6976879.3294,501054.7453 6976877.3945,501052.4879 6976876.2942,501049.4907 6976875.4596,501045.0897 6976875.2699),LINESTRING(501045.0897 6976875.2699,501008.9505 6976879.5707,500992.94 6976882.6817,500961.4502 6976890.2696),LINESTRING(500961.4502 6976890.2696,500933.982 6976896.3399,500916.7575 6976902.3344),LINESTRING(500916.7575 6976902.3344,500867.5879 6976910.3586,500865.1597 6976910.8139,500863.111 6976911.6485,500862.4062 6976912.2161,500862.191 6976913.0618),LINESTRING(500862.191 6976913.0618,500854.1411 6976908.5986),LINESTRING(500854.1411 6976908.5986,500853.8158 6976909.7895,500848.9216 6976914.2284,500848.5091 6976914.9214,500848.5411 6976915.7324),LINESTRING(500848.5411 6976915.7324,500848.4771 6976915.9778,500836.2119 6976916.2297),LINESTRING(500836.2119 6976916.2297,500827.1823 6976916.4289),LINESTRING(500827.1823 6976916.4289,500825.6485 6976916.0943,500820.0117 6976913.2041),LINESTRING(500820.0117 6976913.2041,500814.6433 6976901.0255),LINESTRING(500814.6433 6976901.0255,500798.3672 6976903.3018),LINESTRING(500798.3672 6976903.3018,500743.8449 6976910.9339),LINESTRING(500743.8449 6976910.9339,500740.9078 6976911.345,500724.7266 6976914.7216,500717.3663 6976916.0495,500710.4993 6976916.7704,500694.963 6976918.3259),LINESTRING(500694.963 6976918.3259,500678.319 6976918.909,500650.7255 6976916.1254),LINESTRING(500650.7255 6976916.1254,500630.6935 6976912.3694,500611.0787 6976907.5511),LINESTRING(500611.0787 6976907.5511,500560.1639 6976895.7234),LINESTRING(500560.1639 6976895.7234,500504.26 6976882.6058),LINESTRING(500504.26 6976882.6058,500479.6373 6976877.3702,500455.356 6976873.0451),LINESTRING(500455.356 6976873.0451,500439.8577 6976871.5654,500419.0099 6976870.5411,500395.6771 6976869.8581),LINESTRING(500395.6771 6976869.8581,500395.6392 6976868.6441),LINESTRING(500395.6392 6976868.6441,500399.1486 6976858.8841),LINESTRING(500399.1486 6976858.8841,500400.4191 6976855.9272),LINESTRING(500400.4191 6976855.9272,500381.1273 6976853.0415),LINESTRING(500381.1273 6976853.0415,500370.7085 6976852.0658),LINESTRING(500370.7085 6976852.0658,500370.711 6976852.9569,500370.5376 6976853.9039,500370.2308 6976854.4908,500368.3101 6976857.5719,500366.9948 6976860.3258),LINESTRING(500366.9948 6976860.3258,500356.9282 6976853.3956),LINESTRING(500356.9282 6976853.3956,500357.4963 6976853.0111,500357.8164 6976852.1608,500358.3952 6976851.5239),LINESTRING(500358.3952 6976851.5239,500361.8098 6976847.0723),LINESTRING(500361.8098 6976847.0723,500362.695 6976844.5051,500362.8974 6976842.2287,500362.4927 6976837.5748,500361.7339 6976833.1738,500360.8233 6976826.155,500359.3563 6976818.2636,500354.9554 6976805.4274),LINESTRING(500354.9554 6976805.4274,500354.9806 6976806.2114,500354.8036 6976806.8185,500351.3722 6976815.6415,500351.0687 6976816.3834,500351.1698 6976816.8893,500351.3047 6976817.6987))')
                              ,3,1) as sGeom
        ) as f;

select sGeom, ST_GeometryType(sGeom), ST_NumGeometries(sGeom) as nGeoms from (
 select spdba.ST_Stitch(ST_Collect(geom),2,1) as sGeom 
  from (select a.id, a.geom 
          from (select 1 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501235.5867 6976794.9912,501248.1797 6976793.4472)') as geom union all
                select 2 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501248.1797 6976793.4472,501252.2116 6976813.9985)') union all
                select 3 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501252.2116 6976813.9985,501256.2997 6976837.2336,501256.4777 6976837.3354,501256.6565 6976837.3463)') union all
                select 4 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501256.6565 6976837.3463,501257.9184 6976837.1226,501264.6498 6976835.7263,501275.5786 6976833.6172,501281.4207 6976832.6611)') union all
                select 5 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501281.4207 6976832.6611,501275.5786 6976833.6172,501264.6498 6976835.7263,501257.9184 6976837.1226,501256.6565 6976837.3463)') union all
                select 6 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501256.6565 6976837.3463,501256.1124 6976837.5643,501254.1699 6976837.917,501225.7922 6976842.6248)') union all
                select 7 as id, ST_GeomFromEWKT('SRID=28356;LINESTRING(501225.7922 6976842.6248,501188.0932 6976848.5366,501188.0891 6976848.5366)') 
               ) as a 
          order by random()
	 ) as a
) as b;

/*
SELECT array_agg((geom).path[1] || '@' || ST_AsText((geom).geom)) as geom
  FROM (select ST_Dump(ST_GeomFromEWKT('SRID=28356;GEOMETRYCOLLECTION(LINESTRING(501281.4207 6976832.6611,501281.6022 6976832.6626,501281.75 6976832.7345,501282.2529 6976839.0071,501282.283 6976839.262,501282.3433 6976839.4648,501282.4133 6976839.6708,501282.4941 6976839.8375,501282.5982 6976839.991,501282.7298 6976840.0705,501282.8976 6976840.1079,501283.0806 6976840.1308,501283.256 6976840.1335,501283.7356 6976840.1171,501284.1349 6976840.1076),LINESTRING(501256.6565 6976837.3463,501257.9184 6976837.1226,501264.6498 6976835.7263,501275.5786 6976833.6172,501281.4207 6976832.6611),LINESTRING(501256.6565 6976837.3463,501256.1124 6976837.5643,501254.1699 6976837.917,501225.7922 6976842.6248),LINESTRING(501225.7922 6976842.6248,501188.0932 6976848.5366,501188.0891 6976848.5366),LINESTRING(501188.0891 6976848.5366,501187.9452 6976848.5592,501187.2545 6976848.4359,501186.5885 6976848.2139,501183.867 6976846.7997,501182.6583 6976846.3721,501181.5483 6976846.2673),LINESTRING(501181.5483 6976846.2673,501131.5242 6976854.6869),LINESTRING(501131.5242 6976854.6869,501130.0268 6976854.9817,501128.661 6976855.5318,501126.3561 6976856.8028,501124.8101 6976858.2066,501124.0229 6976859.2025,501123.909 6976859.589),LINESTRING(501123.909 6976859.589,501111.8566 6976863.6244,501105.091 6976865.5384,501097.7687 6976867.2457,501082.555 6976869.7497,501078.7231 6976870.6792,501076.7692 6976871.4759,501075.0809 6976872.69,501073.734 6976874.4352,501072.7666 6976876.3322,501072.3303 6976878.1153,501072.0078 6976880.0502),LINESTRING(501072.0078 6976880.0502,501059.0704 6976881.6816),LINESTRING(501059.0704 6976881.6816,501058.4401 6976880.6662,501057.1165 6976879.3294,501054.7453 6976877.3945,501052.4879 6976876.2942,501049.4907 6976875.4596,501045.0897 6976875.2699),LINESTRING(501045.0897 6976875.2699,501008.9505 6976879.5707,500992.94 6976882.6817,500961.4502 6976890.2696),LINESTRING(500961.4502 6976890.2696,500933.982 6976896.3399,500916.7575 6976902.3344),LINESTRING(500916.7575 6976902.3344,500867.5879 6976910.3586,500865.1597 6976910.8139,500863.111 6976911.6485,500862.4062 6976912.2161,500862.191 6976913.0618),LINESTRING(500862.191 6976913.0618,500854.1411 6976908.5986),LINESTRING(500854.1411 6976908.5986,500853.8158 6976909.7895,500848.9216 6976914.2284,500848.5091 6976914.9214,500848.5411 6976915.7324),LINESTRING(500848.5411 6976915.7324,500848.4771 6976915.9778,500836.2119 6976916.2297),LINESTRING(500836.2119 6976916.2297,500827.1823 6976916.4289),LINESTRING(500827.1823 6976916.4289,500825.6485 6976916.0943,500820.0117 6976913.2041),LINESTRING(500820.0117 6976913.2041,500814.6433 6976901.0255),LINESTRING(500814.6433 6976901.0255,500798.3672 6976903.3018),LINESTRING(500798.3672 6976903.3018,500743.8449 6976910.9339),LINESTRING(500743.8449 6976910.9339,500740.9078 6976911.345,500724.7266 6976914.7216,500717.3663 6976916.0495,500710.4993 6976916.7704,500694.963 6976918.3259),LINESTRING(500694.963 6976918.3259,500678.319 6976918.909,500650.7255 6976916.1254),LINESTRING(500650.7255 6976916.1254,500630.6935 6976912.3694,500611.0787 6976907.5511),LINESTRING(500611.0787 6976907.5511,500560.1639 6976895.7234),LINESTRING(500560.1639 6976895.7234,500504.26 6976882.6058),LINESTRING(500504.26 6976882.6058,500479.6373 6976877.3702,500455.356 6976873.0451),LINESTRING(500455.356 6976873.0451,500439.8577 6976871.5654,500419.0099 6976870.5411,500395.6771 6976869.8581),LINESTRING(500395.6771 6976869.8581,500395.6392 6976868.6441),LINESTRING(500395.6392 6976868.6441,500399.1486 6976858.8841),LINESTRING(500399.1486 6976858.8841,500400.4191 6976855.9272),LINESTRING(500400.4191 6976855.9272,500381.1273 6976853.0415),LINESTRING(500381.1273 6976853.0415,500370.7085 6976852.0658),LINESTRING(500370.7085 6976852.0658,500370.711 6976852.9569,500370.5376 6976853.9039,500370.2308 6976854.4908,500368.3101 6976857.5719,500366.9948 6976860.3258),LINESTRING(500366.9948 6976860.3258,500356.9282 6976853.3956),LINESTRING(500356.9282 6976853.3956,500357.4963 6976853.0111,500357.8164 6976852.1608,500358.3952 6976851.5239),LINESTRING(500358.3952 6976851.5239,500361.8098 6976847.0723),LINESTRING(500361.8098 6976847.0723,500362.695 6976844.5051,500362.8974 6976842.2287,500362.4927 6976837.5748,500361.7339 6976833.1738,500360.8233 6976826.155,500359.3563 6976818.2636,500354.9554 6976805.4274),LINESTRING(500354.9554 6976805.4274,500354.9806 6976806.2114,500354.8036 6976806.8185,500351.3722 6976815.6415,500351.0687 6976816.3834,500351.1698 6976816.8893,500351.3047 6976817.6987))')
                      ) as geom
       ) as f;
*/

